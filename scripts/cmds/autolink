const axios = require("axios");
const fs = require("fs-extra");
const tinyurl = require("tinyurl");

const baseApiUrl = async () => {
  return `https://www.noobs-api.rf.gd/dipto`;
};

module.exports.config = {
  name: "autolink",
  version: "1.0.0",
  hasPermssion: 0,
  credits: "RAHAT",
  description: "Facebook, TikTok, CapCut, YouTube, Instagram, Pinterest, Imgur Downloader",
  commandCategory: "other",
  category: "others",
  usage: "link",
  usePrefix: true,
  prefix: true,
  cooldowns: 2,
  dependencies: {
    axios: "",
    "fs-extra": "",
    tinyurl: "",
  },
};

module.exports.handleEvent = async function ({ api, event }) {
  let dipto = event.body ? event.body.trim() : "";

  try {
    if (
      dipto.startsWith("https://vt.tiktok.com") ||
      dipto.startsWith("https://vm.tiktok.com") ||
      dipto.startsWith("https://www.facebook.com") ||
      dipto.startsWith("https://fb.watch") ||
      dipto.startsWith("https://www.tiktok.com/t/") ||
      dipto.startsWith("https://www.capcut.com/t/") ||
      dipto.startsWith("https://www.instagram.com/") ||
      dipto.startsWith("https://youtu.be/") ||
      dipto.startsWith("https://www.instagram.com/p/") ||
      dipto.startsWith("https://pin.it/") ||
      dipto.startsWith("https://youtube.com/")
    ) {
      api.sendMessage(
        "ğŸ“¥ Please wait, processing your video download...\n\nusername Api",
        event.threadID,
        event.messageID
      );

      const res = await axios.get(
        `${await baseApiUrl()}/alldl?url=${encodeURIComponent(dipto)}`
      );
      const bb = res.data;

      if (!bb || !bb.result) {
        return api.sendMessage(
          "âš ï¸ Failed to fetch download link. Please check your URL.",
          event.threadID,
          event.messageID
        );
      }

      const shortUrl = await tinyurl.shorten(bb.result);
      const MSG = `âœ… username Api â€” Download URL: ${shortUrl}`;

      let ex, cp;
      if (bb.result.includes(".jpg")) {
        ex = ".jpg";
        cp = "ğŸ–¼ï¸ Here's your Photo:";
      } else if (bb.result.includes(".png")) {
        ex = ".png";
        cp = "ğŸ–¼ï¸ Here's your Photo:";
      } else if (bb.result.includes(".jpeg")) {
        ex = ".jpeg";
        cp = "ğŸ–¼ï¸ Here's your Photo:";
      } else {
        ex = ".mp4";
        cp = "ğŸ¥ Here's your Video:";
      }

      const path = __dirname + `/cache/video${ex}`;
      const fileData = (await axios.get(bb.result, { responseType: "arraybuffer" })).data;
      fs.writeFileSync(path, Buffer.from(fileData));

      api.sendMessage(
        {
          body: `${cp}\n${MSG}`,
          attachment: fs.createReadStream(path),
        },
        event.threadID,
        () => fs.unlinkSync(path),
        event.messageID
      );
    }

    // Imgur Direct Downloader
    if (dipto.startsWith("https://i.imgur.com")) {
      const diptoExt = dipto.substring(dipto.lastIndexOf("."));
      const response = await axios.get(dipto, { responseType: "arraybuffer" });
      const filename = __dirname + `/cache/dipto${diptoExt}`;
      fs.writeFileSync(filename, Buffer.from(response.data));

      api.sendMessage(
        {
          body: `ğŸ“¥ Downloaded from Imgur`,
          attachment: fs.createReadStream(filename),
        },
        event.threadID,
        () => fs.unlinkSync(filename),
        event.messageID
      );
    }
  } catch (e) {
    api.sendMessage(`âŒ Error: ${e.message}`, event.threadID, event.messageID);
  }
};

module.exports.run = function () {};
